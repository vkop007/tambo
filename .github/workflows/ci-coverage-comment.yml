name: CI / Coverage Comment

# This workflow runs AFTER the CI workflow completes.
# It posts coverage comments on PRs, including fork PRs.
# Using workflow_run ensures fork code never runs with write permissions.

on:
  workflow_run:
    workflows: [CI]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  comment:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get PR info
        id: pr
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            // Get the PR number from the artifact name
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            const coverageArtifact = artifacts.data.artifacts.find(
              (artifact) => artifact.name.startsWith('coverage-')
            );

            if (!coverageArtifact) {
              core.setOutput('found', 'false');
              return;
            }

            const prNumber = coverageArtifact.name.replace('coverage-', '');
            core.setOutput('found', 'true');
            core.setOutput('number', prNumber);

            // Get the PR to find the base branch
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber),
            });

            core.setOutput('base_branch', pr.data.base.ref);

      - name: Download PR coverage artifact
        if: steps.pr.outputs.found == 'true'
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: coverage-${{ steps.pr.outputs.number }}
          path: coverage-pr
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore base branch coverage from cache
        if: steps.pr.outputs.found == 'true'
        id: base-cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: "**/coverage/coverage-summary.json"
          key: coverage-${{ steps.pr.outputs.base_branch }}-latest
          restore-keys: |
            coverage-${{ steps.pr.outputs.base_branch }}-

      - name: Move base coverage to separate directory
        if: steps.pr.outputs.found == 'true' && steps.base-cache.outputs.cache-hit == 'true'
        run: |
          mkdir -p coverage-base
          find . -path './coverage-pr' -prune -o -path './coverage-base' -prune -o -name 'coverage-summary.json' -print | while read -r file; do
            dest="coverage-base/${file#./}"
            mkdir -p "$(dirname "$dest")"
            mv "$file" "$dest"
          done

      - name: Build coverage report with comparison
        if: steps.pr.outputs.found == 'true'
        id: coverage
        shell: bash
        run: |
          set -euo pipefail

          has_base="${{ steps.base-cache.outputs.cache-hit == 'true' }}"

          # Function to extract coverage percentage from JSON
          get_coverage() {
            local file="$1"
            if [[ -f "$file" ]]; then
              jq -r '.total.lines.pct // .total.statements.pct // 0' "$file"
            else
              echo "0"
            fi
          }

          # Build the coverage files list and comparison data
          coverage_files=""
          comparison_table="| Package | Coverage | Change |"$'\n'"| --- | --- | --- |"

          while IFS= read -r file; do
            # Extract package path
            package_path="${file#coverage-pr/}"
            package_path="${package_path%/coverage/coverage-summary.json}"

            # Convert path to title
            title=$(echo "$package_path" | sed 's/-/ /g; s/\// /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)} 1')

            # Build coverage_files list for jest-coverage-comment
            if [[ -n "$coverage_files" ]]; then
              coverage_files="${coverage_files}"$'\n'
            fi
            coverage_files="${coverage_files}${title}, ./${file}"

            # Get PR coverage
            pr_cov=$(get_coverage "$file")

            # Get base coverage if available
            base_file="coverage-base/${package_path}/coverage/coverage-summary.json"
            if [[ "$has_base" == "true" ]] && [[ -f "$base_file" ]]; then
              base_cov=$(get_coverage "$base_file")
              diff=$(echo "$pr_cov - $base_cov" | bc)
              if (( $(echo "$diff > 0" | bc -l) )); then
                change="+${diff}% üìà"
              elif (( $(echo "$diff < 0" | bc -l) )); then
                change="${diff}% üìâ"
              else
                change="¬±0%"
              fi
            else
              change="N/A (no base)"
            fi

            comparison_table="${comparison_table}"$'\n'"| ${title} | ${pr_cov}% | ${change} |"
          done < <(find coverage-pr -name "coverage-summary.json" -type f | sort)

          if [[ -z "$coverage_files" ]]; then
            echo "has_coverage=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_coverage=true" >> "$GITHUB_OUTPUT"
            echo "coverage_files<<EOF" >> "$GITHUB_OUTPUT"
            echo "$coverage_files" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "comparison_table<<EOF" >> "$GITHUB_OUTPUT"
            echo "$comparison_table" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Post coverage comment
        if: steps.pr.outputs.found == 'true' && steps.coverage.outputs.has_coverage == 'true'
        uses: mshick/add-pr-comment@b69c439d72a4e2139652e75967b48352f6413c81 # v2.8.2
        with:
          issue: ${{ steps.pr.outputs.number }}
          message-id: coverage-report
          message: |
            ## Test Coverage Report

            ${{ steps.coverage.outputs.comparison_table }}

            <details>
            <summary>Coverage compared against <code>${{ steps.pr.outputs.base_branch }}</code> branch</summary>

            Base coverage cache: ${{ steps.base-cache.outputs.cache-hit == 'true' && '‚úÖ Found' || '‚ö†Ô∏è Not found (first PR or cache expired)' }}
            </details>
